<!DOCTYPE html>
<html lang="en" style="height:100%">

<head>
    <meta charset="utf-8">

    <title>Beehive</title>

    <!-- Bootstrap core CSS -->
    <link href="dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="css/panelevents.css" rel="stylesheet" />
    <script type="text/javascript" src="http://maps.googleapis.com/maps/api/js"></script>
    <script src="https://cdn.firebase.com/js/client/2.4.1/firebase.js"></script>
    <script type="text/javascript" src="js/db.js"></script>
    <script>
    var state = {
      events: []
    };

    /*createEvent(
      "New Event",
      {
        lat: 46.5,
        lon: 6.5
      },
      new Date(2015,03,13,15,00,00,0),
      new Date(2015,03,13,16,00,00,0),
      "Punching Ruben",
      "Gonna be fuun!"
    );*/
    var map;
    var labels = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
    var labelIndex = 0;
    var markers = [];
    function initialize() {
      var mapProp = {
        center:new google.maps.LatLng(46.5, 6.5),
        zoom:10,
        mapTypeId:google.maps.MapTypeId.ROADMAP
      };
      map=new google.maps.Map(document.getElementById("map"),mapProp);
      navigator.geolocation.getCurrentPosition(function(position){
        state.position = position.coords,
        map.panTo(new google.maps.LatLng(position.coords.latitude, position.coords.longitude));
      });

      map.setOptions({styles: [{"featureType":"administrative","elementType":"labels.text.fill","stylers":[{"color":"#6195a0"}]},{"featureType":"landscape","elementType":"all","stylers":[{"color":"#f2f2f2"}]},{"featureType":"landscape","elementType":"geometry.fill","stylers":[{"color":"#ffffff"}]},{"featureType":"poi","elementType":"all","stylers":[{"visibility":"off"}]},{"featureType":"poi.park","elementType":"geometry.fill","stylers":[{"color":"#e6f3d6"},{"visibility":"on"}]},{"featureType":"road","elementType":"all","stylers":[{"saturation":-100},{"lightness":45},{"visibility":"simplified"}]},{"featureType":"road.highway","elementType":"all","stylers":[{"visibility":"simplified"}]},{"featureType":"road.highway","elementType":"geometry.fill","stylers":[{"color":"#f4d2c5"},{"visibility":"simplified"}]},{"featureType":"road.highway","elementType":"labels.text","stylers":[{"color":"#4e4e4e"}]},{"featureType":"road.arterial","elementType":"geometry.fill","stylers":[{"color":"#f4f4f4"}]},{"featureType":"road.arterial","elementType":"labels.text.fill","stylers":[{"color":"#787878"}]},{"featureType":"road.arterial","elementType":"labels.icon","stylers":[{"visibility":"off"}]},{"featureType":"transit","elementType":"all","stylers":[{"visibility":"off"}]},{"featureType":"water","elementType":"all","stylers":[{"color":"#eaf6f8"},{"visibility":"on"}]},{"featureType":"water","elementType":"geometry.fill","stylers":[{"color":"#eaf6f8"}]}]});

    }
    google.maps.event.addDomListener(window, 'load', initialize);
    </script>
</head>

<body style="height: 100%">

    <div id="container" style="width:100%;height: 100%">
        <div id="container" style="width:30%;height: 100%;float: right;padding:20px">
            <div align="center">
                <img src="img/logo.png" height="100px" />
            </div>
            <form>
                <div class="form-group">
                    <label for="range">Search range</label>
                    <input type="number" class="form-control" id="range" value="" onchange="query();" />
                </div>
                <div class="form-group">
                    <label for="start">From</label>
                    <input type="date" class="form-control" id="start" value="" onchange="query();" />
                </div>
                <div class="form-group">
                    <label for="end">To</label>
                    <input type="date" class="form-control" id="end" value="" onchange="query();" />
                </div>
            </form>

            <div class="row">
                <div class="col-lg-6 text-left">
                    <div class="dropdown">
                        <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
                            Categories <span class="caret"></span>
                        </button>
                        <ul class="dropdown-menu">
                            <li>
                                <a href="#" class="medium" data-value="option1" tabIndex="-1">
                                    <input type="checkbox" />&nbsp;Environmental</a>
                            </li>
                            <li>
                                <a href="#" class="medium" data-value="option2" tabIndex="-1">
                                    <input type="checkbox" />&nbsp;Social work</a>
                            </li>
                            <li>
                                <a href="#" class="medium" data-value="option3" tabIndex="-1">
                                    <input type="checkbox" />&nbsp;Social discourse</a>
                            </li>
                            <li>
                                <a href="#" class="medium" data-value="option4" tabIndex="-1">
                                    <input type="checkbox" />&nbsp;Neighbourhood friendship</a>
                            </li>
                            <li>
                                <a href="#" class="medium" data-value="option5" tabIndex="-1">
                                    <input type="checkbox" />&nbsp;Farming</a>
                            </li>
                            <li>
                                <a href="#" class="medium" data-value="option6" tabIndex="-1">
                                    <input type="checkbox" />&nbsp;Collaborative Art</a>
                            </li>
                        </ul>
                    </div>
                </div>
                <div class="col-lg-6 text-right">
                    <button type="button" class="btn btn-primary">Search for some fun</button>
                </div>
            </div>
 </div>

        <div id="container" style="width:70%;height: 100%">
            <div id="map" style="width:100%;height:100%">
            </div>
            <div class="modal fade" id="eventModal" role="dialog">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal">&times;</button>
                            <h4 id="eventName"></h4>
                            <p class="modal-title">User</p>
                        </div>
                        <div class="modal-body">

                            <div class="row">
                                <div class="col-md-8">
                                    
                                    <label>Description</label>
                                    <br>
                                    <div id="description"></div>
                                    <label>Category</label>
                                    <br>
                                    <div id="categorie"></div>
                                </div>
                                <div class="col-md-4">
                                    <form>
                                        <div class="form-group">
                                            <label for="nbP">Number of participant:</label>
                                            <div id="nbP"></div>
                                        </div>
                                        <div class="form-group">
                                            <label for="where">Where</label>
                                            <div id="eventLocation"></div>
                                        </div>
                                        <div class="form-group">
                                            <label for="when">When</label>
                                            <div id="times"></div>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary" id="goingButton">Going</button>
                            <button type="button" class="btn btn-success">Interested</button>
                            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
    <script src="dist/js/bootstrap.min.js"></script>
    <script src="js/dropdown.js"></script>
    <script type="text/javascript">
      document.getElementById("range").value = 20;
      document.getElementById("start").value = new Date("2015-01-01");
      document.getElementById("end").value = new Date("2015-12-31");

      function addMarker(location, map,eventID) {
        // Add the marker at the clicked location, and add the next-available label
        // from the array of alphabetical characters.
        var marker = new google.maps.Marker({
          position: { lat: location.lat, lng: location.lon },
          label: labels[labelIndex++ % labels.length],
          map: map
        });

        marker.addListener('click', function() {
            openModal(events.eventID)
        });
        markers.push(marker);
      }
      
      function openModal(eventData) {
          console.log("blah");
          $('#eventModal').modal('show');
          $("#description").html(eventData.description);
          $("#nbP").html(eventData.eventData.participantcount || 0);
          //$("#eventLocation").html(eventData.eventLocation);
          $("#times").html(eventData.times.start + '\n' + eventData.times.end);
          $("#eventName").html(eventData.eventData.name);
          $('#categorie').html(eventData.eventData.category);
          isSubscribedTo(eventData.eventID, function (subscribed) {
            console.log(eventData.eventID);
            console.log(subscribed);
            if (subscribed) {
              $('#goingButton').prop("disabled", true);
              $('#goingButton').unbind("click");              
            } else {
              $('#goingButton').prop("disabled", false);
              $('#goingButton').bind("click", {id: eventData.eventID}, function (event) {
                console.log(event.data.id);
                subscribe(event.data.id);
                $('#goingButton').prop("disabled", true);
                $('#goingButton').unbind("click");
              });              
            }
          });
      }
      
      query();
      function query() {

        for (var i = 0; i < markers.length; i++) {
            markers[i].setMap(map);
        }
  
        var start = new Date(document.getElementById("start").value);
        var end = new Date(document.getElementById("end").value);
        var range = document.getElementById("range").value;
        var category = "Punching Ruben";
        //var category = document.getElementById("category").value;
        navigator.geolocation.getCurrentPosition(function(position){

            getEvents(start, end, position.coords, range, category, function(eventID, eventData, times, eventLocation, description){
                addMarker(eventLocation,map,eventID);
                events.eventID = {
                    eventID : eventID, 
                    eventData : eventData, 
                    times : times, 
                    eventLocation : eventLocation, 
                    description : description
                }
            });
        });

      }
    </script>

</body>

</html>